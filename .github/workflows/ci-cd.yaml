name: dbk-oidc-sso-toolkit
 
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
 
jobs:
  build:
    runs-on: ubuntu-latest
 
    env:
      ROOT_DIR: ${{ github.workspace }}
      TMP_DIR: ${{ github.workspace }}/tmp
      VERSION: "ci-${{ github.run_number }}-${{ github.sha }}"
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
 
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
 
      - name: Prepare directories
        run: |
          rm -rf "$TMP_DIR"
          mkdir -p "$TMP_DIR"
          echo "TMP directory: $TMP_DIR"
 
      - name: Install frontend dependencies
        working-directory: sample-web-app/frontend
        run: npm ci
 
      - name: Install backend dependencies
        working-directory: sample-web-app/backend
        run: npm ci
 
      - name: Build frontend
        working-directory: sample-web-app/frontend
        run: |
          echo "Building frontend..."
          npm run build
          echo "Frontend build complete."
 
      - name: Build backend
        working-directory: sample-web-app/backend
        run: |
          echo "Building backend..."
          npm run build
          echo "Backend build complete."

      - name: Install dependencies (root) playwright
        working-directory: sample-web-app
        run: npm ci
 
      - name: Run backend tests
        working-directory: sample-web-app/backend
        run: npm test

      - name: Run backend e2e tests
        working-directory: sample-web-app/backend
        run: npm run test:e2e
        
      - name: Upload e2e JUnit Test Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-e2e-junit
          path: sample-web-app/backend/test-results/junit/jest-e2e.xml

      - name: Upload e2e HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-e2e-html
          path: sample-web-app/backend/test-results/html/e2e-report.html

      - name: Publish Test Summary
        uses: test-summary/action@v2
        with:
          paths: sample-web-app/backend/test-results/junit/jest-e2e.xml

      - name: Install Playwright Browsers
        working-directory: sample-web-app
        run: npx playwright install chromium

      - name: Run frontend e2e tests
        working-directory: sample-web-app
        run: npx playwright test

      - name: Upload e2e HTML frontend Report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-e2e-html
          path: sample-web-app/frontend/test-results/frontend-report.html

      - name: Build Docker Image
        run: |
          docker build -t oidc-sso-toolkit:latest -f ./sample-web-app/Dockerfile ./sample-web-app
 
      - name: Verify Docker Image Build
        run: docker images | grep oidc-sso-toolkit
 
      - name: Prepare ZIP structure
        run: |
          echo "Preparing ZIP structure..."
          mkdir -p "$TMP_DIR/sample-web-app/frontend"
          cp -r "$ROOT_DIR/sample-web-app/frontend/build" "$TMP_DIR/sample-web-app/frontend/"
          cp "$ROOT_DIR/sample-web-app/frontend/package.json" "$TMP_DIR/sample-web-app/frontend/"
 
          # --- Backend ---
          mkdir -p "$TMP_DIR/sample-web-app/backend"
          cp -r "$ROOT_DIR/sample-web-app/backend/dist" "$TMP_DIR/sample-web-app/backend/"
          cp "$ROOT_DIR/sample-web-app/backend/package.json" "$TMP_DIR/sample-web-app/backend/"
 
          cp "$ROOT_DIR/sample-web-app/README.md" "$TMP_DIR/sample-web-app/" || true
          cp "$ROOT_DIR/sample-web-app/Dockerfile" "$TMP_DIR/sample-web-app" || true

          # --- Scripts ---
          mkdir -p "$TMP_DIR/sample-web-app/scripts"
          cp "$ROOT_DIR/scripts/init.sh" "$TMP_DIR/sample-web-app/scripts/" || true
          cp "$ROOT_DIR/scripts/run-web-app.sh" "$TMP_DIR/sample-web-app/scripts/" || true
          cp "$ROOT_DIR/scripts/selftest.sh" "$TMP_DIR/sample-web-app/scripts/" || true
 
          # --- Documentation ---
          mkdir -p "$TMP_DIR/documentation"
          cp -r "$ROOT_DIR/documentation/." "$TMP_DIR/documentation/" || true
 
          # --- Root files ---
          cp "$ROOT_DIR/README.md" "$TMP_DIR/" || true
          echo "prepared zip structure [DONE]"
 
      - name: Create flattened ZIP
        run: |
          ZIP_NAME="oidc-sso-toolkit-${{ github.run_number }}.zip"
          FINAL_ZIP_PATH="${{ github.workspace }}/$ZIP_NAME"
          echo "Creating flattened ZIP at $FINAL_ZIP_PATH..."
          (cd "$TMP_DIR" && zip -r "$FINAL_ZIP_PATH" ./* > /dev/null)
          echo "Created flattened ZIP at $FINAL_ZIP_PATH"
          unzip -l "$FINAL_ZIP_PATH" | head -20
 
      - name: Verify ZIP content
        run: |
          echo "Verifying flattened ZIP:"
          ls -lh *.zip
          echo "Inspecting structure:"
          unzip -l "oidc-sso-toolkit-${{ github.run_number }}.zip" | head -30
 
      - name: Deploy - Extract and Run Docker Container
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Starting CD process..."
          ZIP_FILE="oidc-sso-toolkit-${{ github.run_number }}.zip"
          DEPLOY_DIR="${{ github.workspace }}/deploy"
         
          echo "Extracting ZIP package..."
          mkdir -p "$DEPLOY_DIR"
          unzip -q "$ZIP_FILE" -d "$DEPLOY_DIR"
 
          echo " Building Docker image from extracted files..."
          cd "$DEPLOY_DIR/sample-web-app"
          docker build -t oidc-sso-toolkit:latest .
 
          echo " Running Docker container..."
          docker run -d --name oidc-sso-toolkit \
            -p 8000:8000 \
            -p 9000:9000 \
            oidc-sso-toolkit:latest
 
          echo " Waiting for containers to initialize..."
          sleep 15
 
          echo " Checking application health..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000)
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9000/api/health)
 
          echo " Frontend (8000) HTTP status: $FRONTEND_STATUS"
          echo " Backend (9000) HTTP status: $BACKEND_STATUS"
 
          if [ "$FRONTEND_STATUS" -eq 200 ] && [ "$BACKEND_STATUS" -eq 200 ]; then
            echo " Both frontend and backend are running successfully!"
          else
            echo " One or both services failed to start properly!"
            echo " Displaying container logs for debugging..."
            docker logs oidc-sso-toolkit || true
            echo " Showing running containers..."
            docker ps -a
            exit 1
          fi
 
      - name: Show Running Containers
        run: docker ps -a

      - name: Upload packaged ZIP
        uses: actions/upload-artifact@v4
        with:
          name: oidc-sso-toolkit
          path: oidc-sso-toolkit-${{ github.run_number }}.zip

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -rf "$TMP_DIR"
          echo "Cleaned temporary files."
 