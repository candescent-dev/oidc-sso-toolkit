name: Sync to Public GitHub

# Triggers: push to main, or manual dispatch
on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PUBLIC_REPO: "candescent-dev/oidc-sso-toolkit"

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout internal repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          # GitHub App credentials - add these as secrets in EMU repo
          app-id: ${{ secrets.SYNC_APP_ID }}
          private-key: ${{ secrets.SYNC_APP_PRIVATE_KEY }}
          owner: candescent-dev
          repositories: oidc-sso-toolkit
        continue-on-error: false

      - name: Verify GitHub App token
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "âŒ Error: GitHub App token is empty"
            echo "Check that SYNC_APP_ID and SYNC_APP_PRIVATE_KEY secrets are set correctly"
            echo "Token output: ${{ steps.app-token.outputs.token }}"
            exit 1
          fi
          echo "âœ… GitHub App token generated successfully"
          echo "Token length: ${#GH_TOKEN} characters"
          echo "Token preview: ${GH_TOKEN:0:20}..."
          
          # Test token by checking if we can access the repo via API
          echo "Testing repository access to ${{ env.PUBLIC_REPO }} via API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ env.PUBLIC_REPO }})
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Error: Cannot access repository ${{ env.PUBLIC_REPO }} via API"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify the repository exists (even if private): https://github.com/${{ env.PUBLIC_REPO }}"
            echo "2. Ensure the GitHub App is installed on the repository"
            echo "3. Check that the App has 'Contents: Write' permission"
            echo "4. Verify the repository name matches exactly: oidc-sso-toolkit"
            echo "5. Check the App installation settings in GitHub"
            exit 1
          fi
          echo "âœ… Repository API access verified (HTTP $HTTP_CODE)"
          
          # Also test git access
          echo "Testing git access..."
          git config --global credential.helper store
          echo "https://x-access-token:${GH_TOKEN}@github.com" > ~/.git-credentials
          
          if git ls-remote https://github.com/${{ env.PUBLIC_REPO }}.git > /dev/null 2>&1; then
            echo "âœ… Git access verified"
          else
            echo "âš ï¸  Git ls-remote failed, but API access works - will try push anyway"
            git ls-remote https://github.com/${{ env.PUBLIC_REPO }}.git 2>&1 || true
          fi

      - name: Push to public repo
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Configure git with GitHub App bot identity
          git config user.name "candescent-oidc-sync-bot[bot]"
          git config user.email "${{ secrets.SYNC_APP_ID }}+candescent-oidc-sync-bot[bot]@users.noreply.github.com"
          
          # Configure git credential helper for this step
          git config --global credential.helper store
          echo "https://x-access-token:${GH_TOKEN}@github.com" > ~/.git-credentials
          
          # Remove existing remote if it exists
          git remote remove public 2>/dev/null || true
          
          # Add remote (git will use credentials from helper)
          git remote add public https://github.com/${{ env.PUBLIC_REPO }}.git
          
          # Check if repository is empty (no branches)
          echo "Checking repository state..."
          BRANCHES=$(git ls-remote --heads public 2>&1 || echo "error")
          if echo "$BRANCHES" | grep -q "error\|Repository not found"; then
            echo "âš ï¸  Cannot list branches, but will attempt push anyway"
            echo "Output: $BRANCHES"
          else
            echo "Available branches:"
            echo "$BRANCHES" || echo "Repository appears empty"
          fi
          
          # Force push to public (mirror sync)
          # If repository is empty, this will create the main branch
          echo "Pushing to ${{ env.PUBLIC_REPO }}..."
          if git push public main:main --force; then
            echo "âœ… Synced to public repository"
          else
            PUSH_ERROR=$?
            echo "âŒ Push failed (exit code: $PUSH_ERROR)"
            echo ""
            echo "Debugging information:"
            echo "Repository: ${{ env.PUBLIC_REPO }}"
            echo "Token length: ${#GH_TOKEN}"
            echo ""
            echo "Please verify:"
            echo "1. The GitHub App is installed on the repository"
            echo "2. The App has 'Contents: Write' permission"
            echo "3. The repository name is correct: oidc-sso-toolkit"
            echo "4. The App installation includes this specific repository"
            echo "5. Check GitHub App settings: https://github.com/organizations/candescent-dev/settings/apps/candescent-oidc-sync-bot"
            exit $PUSH_ERROR
          fi

      - name: Summary
        run: |
          echo "## Sync Complete ðŸ”„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ env.PUBLIC_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

